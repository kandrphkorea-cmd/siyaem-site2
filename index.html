<!-- SiyaEm: единый скрипт карты -->
<script>
(function(){
  // Стили — плющим все сторонние POI/иконки
  const SIYAEM_MAP_STYLES = [
    { featureType: "poi", stylers: [{ visibility: "off" }] },
    { featureType: "poi.business", stylers: [{ visibility: "off" }] },
    { featureType: "poi.attraction", stylers: [{ visibility: "off" }] },
    { featureType: "poi.medical", stylers: [{ visibility: "off" }] },
    { featureType: "poi.government", stylers: [{ visibility: "off" }] },
    { featureType: "poi.school", stylers: [{ visibility: "off" }] },
    { featureType: "poi.sports_complex", stylers: [{ visibility: "off" }] }
  ];

  // Глобальный init для callback
  window.initSiyaem = async function () {
    const center = { lat: 36.9305, lng: 127.0458 }; // Dunpo (Асан)

    const map = new google.maps.Map(document.getElementById("map"), {
      center,
      zoom: 15,
      styles: SIYAEM_MAP_STYLES,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });

    // Грузим partners.json (лежит в корне репозитория)
    let items = [];
    try {
      const res = await fetch("partners.json", { cache: "no-cache" });
      if (!res.ok) throw new Error("partners.json not found");
      items = await res.json();
    } catch (e) {
      console.error("Не удалось загрузить partners.json:", e);
      return; // карта останется пустой
    }

    const approved = Array.isArray(items)
      ? items.filter(x => x && x.approved === true)
      : [];

    const bounds = new google.maps.LatLngBounds();
    let any = false;

    approved.forEach(place => {
      const lat = Number(place.lat), lng = Number(place.lng);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

      const pos = { lat, lng };
      const marker = new google.maps.Marker({
        position: pos,
        map,
        title: place.name
      });

      const infoHtml = `
        <div style="max-width:260px">
          <strong>${place.name ?? ""}</strong><br/>
          <small>${place.province_ru ?? ""} • ${place.city_ru ?? ""}</small><br/>
          <div>Категория: ${place.category ?? "—"}${place.subcategories?.length ? " — " + place.subcategories.join(", ") : ""}</div>
          <div>Рейтинг: ${place.rating ?? "—"}</div>
          <div style="margin-top:6px">${place.address ?? ""}</div>
        </div>
      `;
      const iw = new google.maps.InfoWindow({ content: infoHtml });
      marker.addListener("click", () => iw.open({ anchor: marker, map }));

      bounds.extend(pos);
      any = true;
    });

    if (any) {
      if (approved.length === 1) { map.setCenter(bounds.getCenter()); map.setZoom(17); }
      else { map.fitBounds(bounds); }
    } else {
      map.setCenter(center);
      map.setZoom(14);
    }
  };
})();
</script>

<!-- Единственная загрузка Google Maps с правильным callback -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfroP4Q7_yFpEMPXgDMn-bohk1xRxTkro&callback=initSiyaem"></script>
